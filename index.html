<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>THE NEW COLLEGE | Attendance System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* ========== MODERN PROFESSIONAL DESIGN ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B0000;
            --primary-dark: #6d0000;
            --primary-light: #b22222;
            --secondary: #2c3e50;
            --accent: #3498db;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --border-light: #e2e8f0;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 1rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(145deg, var(--primary) 0%, var(--primary-light) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.5;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            padding: 2.5rem;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .college-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 4px solid var(--primary);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .college-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 10px;
        }

        .college-name {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 0.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .college-tagline {
            color: var(--primary-light);
            font-size: 1rem;
            font-style: italic;
            margin-bottom: 1rem;
        }

        .arabic-text {
            color: var(--primary);
            font-size: 1.25rem;
            font-family: 'Traditional Arabic', serif;
            border-top: 2px solid var(--primary-light);
            border-bottom: 2px solid var(--primary-light);
            padding: 0.75rem;
            background: #fff5f5;
            border-radius: 2rem;
            margin-top: 1rem;
        }

        .arabic-text small {
            font-size: 0.75rem;
            display: block;
            margin-top: 0.25rem;
            color: var(--text-muted);
        }

        .role-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .role-btn {
            padding: 0.5rem 1.5rem;
            border: 2px solid var(--border-light);
            background: white;
            border-radius: 2rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--text-muted);
        }

        .role-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 1rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: var(--light-bg);
        }

        .dashboard.active {
            display: block;
        }

        .navbar {
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn-nav {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
            display: none;
            transition: transform 0.2s;
        }

        .back-btn-nav.visible {
            display: block;
        }

        .back-btn-nav:hover {
            transform: translateX(-3px);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--primary);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }

        .nav-brand h2 {
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .nav-brand small {
            color: var(--primary-light);
            font-size: 0.75rem;
            display: block;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .refresh-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--primary);
            transition: transform 0.5s;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
        }

        .menu-toggle {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
        }

        .main-content {
            margin-top: 80px;
            margin-bottom: 80px;
            padding: 2rem;
            min-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            padding: 0.25rem;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-2px);
        }

        .nav-item span:first-child {
            font-size: 1.25rem;
        }

        /* Full Page Menu */
        .menu-full {
            position: fixed;
            top: 80px;
            left: 0;
            width: 100%;
            height: calc(100vh - 160px);
            background: var(--card-bg);
            z-index: 999;
            overflow-y: auto;
            padding: 2rem;
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .menu-full.open {
            display: block;
        }

        .menu-full .search-box {
            margin-bottom: 2rem;
        }

        .menu-full .search-box input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid var(--border-light);
            border-radius: 2rem;
            font-size: 1rem;
        }

        .menu-section {
            margin-bottom: 2rem;
        }

        .menu-section h3 {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .menu-grid-item {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .menu-grid-item:hover {
            background: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .recent-section {
            margin-bottom: 2rem;
        }

        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .recent-header h3 {
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .clear-all {
            color: var(--primary);
            font-size: 0.85rem;
            cursor: pointer;
            opacity: 0.8;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--light-bg);
            border-radius: 2rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recent-item:hover {
            background: white;
            box-shadow: var(--shadow-sm);
        }

        /* Student Home */
        .student-home {
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .student-header {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        .student-header h1 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .student-header p {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .hours-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        .hour-box {
            flex: 1 1 calc(20% - 0.75rem);
            min-width: 80px;
            padding: 1rem 0.25rem;
            background: var(--light-bg);
            border-radius: 1rem;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .hour-box:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-sm);
        }

        .hour-box.present {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .hour-box.absent {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .hour-box.late {
            background: #fef9c3;
            border-color: #eab308;
        }

        .hour-box.letoff {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .hour-box .hour {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .hour-box .status {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .period-detail-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .period-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-light);
        }

        .period-detail-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .period-detail-header .period-time {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .period-detail-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .period-detail-label {
            min-width: 100px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .period-detail-value.faculty {
            color: var(--primary);
            font-weight: 600;
        }

        .period-detail-value.status {
            padding: 0.25rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
        }

        .period-detail-value.status.present {
            background: #dcfce7;
            color: #166534;
        }

        .period-detail-value.status.absent {
            background: #fee2e2;
            color: #991b1b;
        }

        .period-detail-value.status.late {
            background: #fef9c3;
            color: #854d0e;
        }

        .period-detail-value.status.letoff {
            background: #dbeafe;
            color: #1e40af;
        }

        .period-detail-course {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-bg);
            border-radius: 1rem;
        }

        .view-all-link {
            text-align: right;
        }

        .view-all-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .feedback-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .feedback-section p {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .feedback-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .semester-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .see-all {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .semester-stats {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-top: 1rem;
        }

        .stats-details {
            flex: 1;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed var(--border-light);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
        }

        .percentage-circle {
            width: 90px;
            height: 90px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .percentage-circle::after {
            content: '%';
            font-size: 0.9rem;
            position: absolute;
            top: 30px;
            right: 18px;
        }

        /* Attendance Page */
        .attendance-page {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .attendance-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .attendance-tab {
            padding: 0.5rem 1.5rem;
            border: none;
            background: none;
            color: var(--text-muted);
            font-weight: 500;
            cursor: pointer;
            border-radius: 2rem;
            transition: all 0.2s;
        }

        .attendance-tab.active {
            background: var(--primary);
            color: white;
        }

        .course-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .course-item {
            background: var(--light-bg);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .course-item h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .course-stats {
            display: flex;
            gap: 2rem;
            font-size: 1rem;
            flex-wrap: wrap;
        }

        .month-grid {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .month-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: white;
            border-radius: 2rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .attendance-table th,
        .attendance-table td {
            text-align: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .attendance-table th {
            background: var(--light-bg);
            color: var(--text-dark);
            font-weight: 600;
        }

        .status-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
            justify-content: center;
        }

        .status-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 2rem;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: default;
        }

        .status-btn.present {
            background: #dcfce7;
            color: #166534;
        }

        .status-btn.absent {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-btn.late {
            background: #fef9c3;
            color: #854d0e;
        }

        .status-btn.letoff {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-btn.unmarked {
            background: var(--border-light);
            color: var(--text-muted);
        }

        /* Termly */
        .term-stats {
            margin-top: 1.5rem;
        }

        .term-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .term-header h3 {
            font-size: 1.3rem;
        }

        .term-header span {
            color: var(--primary);
            font-size: 2rem;
            font-weight: bold;
        }

        .term-period {
            background: var(--light-bg);
            padding: 0.75rem;
            border-radius: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-muted);
        }

        .term-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .term-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--light-bg);
            color: var(--text-dark);
            font-weight: 600;
        }

        .term-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        /* Mark Attendance */
        .mark-attendance-page {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            max-width: 900px;
            margin: 0 auto;
        }

        .period-grid {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .period-card {
            flex: 1 1 calc(20% - 0.75rem);
            min-width: 90px;
            padding: 1.5rem 0.5rem;
            background: var(--light-bg);
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .period-card.selected {
            border-color: var(--primary);
            background: #fff0f0;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .course-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 1rem;
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .student-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 1rem;
            background: var(--light-bg);
        }

        .student-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .student-info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .student-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .student-status {
            display: flex;
            gap: 0.5rem;
        }

        .status-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            background: white;
            border: 2px solid var(--border-light);
        }

        .status-option.present.active {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        .status-option.absent.active {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .status-option.late.active {
            background: #fef9c3;
            border-color: #eab308;
            color: #854d0e;
        }

        .status-option.letoff.active {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .submit-btn,
        .btn-primary {
            padding: 1rem 2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover,
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .cancel-btn {
            padding: 1rem 2rem;
            background: var(--text-muted);
            color: white;
            border: none;
            border-radius: 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 1rem;
            transition: all 0.2s;
        }

        .cancel-btn:hover {
            background: #475569;
            transform: translateY(-2px);
        }

        /* Library & Fees */
        .library-page,
        .fees-page {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .checkin-btn {
            background: #22c55e;
        }

        .checkout-btn {
            background: #ef4444;
        }

        .payment-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .payment-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 1rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
        }

        .payment-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .gpay {
            background: #4285F4;
        }

        .phonepay {
            background: #5F259F;
        }

        .card {
            background: #64748b;
        }

        .card-payment-form {
            background: var(--light-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .card-payment-form input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 0.75rem;
        }

        .upi-id {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 1rem;
            font-family: monospace;
            font-size: 1.2rem;
            text-align: center;
            margin: 1rem 0;
        }

        /* Feedback */
        .feedback-item {
            background: var(--light-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .feedback-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .unread {
            background: #fff3cd;
            border-left-color: #eab308;
        }

        /* Admin panel */
        .admin-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .admin-form {
            display: grid;
            gap: 1rem;
            max-width: 600px;
        }

        .bulk-upload-area {
            background: var(--light-bg);
            border: 2px dashed var(--primary);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            margin-top: 1.5rem;
        }

        .bulk-upload-area input[type="file"] {
            margin: 1rem 0;
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card .stat-title {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-value {
            color: var(--text-dark);
            font-size: 2rem;
            font-weight: 700;
        }

        /* Table container */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.75rem;
        }

        .table-header h3 {
            color: var(--text-dark);
            font-size: 1.2rem;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.75rem;
            background: var(--light-bg);
            color: var(--text-dark);
            font-weight: 600;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        /* Notification & loading */
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: var(--card-bg);
            border-radius: 2rem;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 0.75rem;
            z-index: 1500;
            border-left: 4px solid var(--primary);
            font-weight: 500;
        }

        .notification.show {
            display: flex;
        }

        .notification.success {
            border-left-color: #22c55e;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .main-content {
                padding: 1rem;
            }

            .hour-box {
                flex: 1 1 calc(50% - 0.75rem);
            }

            .period-card {
                flex: 1 1 calc(50% - 0.75rem);
            }

            .student-list-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .student-status {
                align-self: flex-end;
            }

            .attendance-tabs {
                gap: 0.25rem;
            }

            .attendance-tab {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .term-header span {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>Loading data...</div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="college-logo">
                    <!-- Single logo with fallback (fixed duplicate) -->
                    <img src="TNC.jpg" alt="THE NEW COLLEGE Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiM4QjAwMDAiLz48dGV4dCB4PSI0MCIgeT0iNDAiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlROQzwvdGV4dD48L3N2Zz4=';">
                </div>
                <h1 class="college-name">THE NEW COLLEGE</h1>
                <div class="college-tagline">Empowering Education, Enriching Lives</div>
                <div class="arabic-text">
                    ÿ±Ÿéÿ®ŸêŸë ÿ≤ÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖÿßŸã
                    <br>
                    <small>"MY LORD! INCREASE ME IN KNOWLEDGE"</small>
                </div>
            </div>
            
            <div class="role-selector">
                <button class="role-btn active" onclick="setRole('student')">Student</button>
                <button class="role-btn" onclick="setRole('staff')">Staff</button>
                <button class="role-btn" onclick="setRole('admin')">Admin</button>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div id="studentFields">
                    <div class="input-group">
                        <label>üìã Register Number</label>
                        <input type="text" id="registerNumber" placeholder="Enter register number">
                    </div>
                    <div class="input-group">
                        <label>üîí Password</label>
                        <input type="password" id="password" placeholder="Enter password">
                        <div class="hint">Password is your register number</div>
                    </div>
                </div>

                <div id="staffAdminFields" style="display: none;">
                    <div class="input-group">
                        <label>üìß Email Address</label>
                        <input type="email" id="email" placeholder="Enter email" >
                    </div>
                    <div class="input-group">
                        <label>üîí Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter password" >
                    </div>
                </div>

                <button type="submit" class="login-btn">Login to Dashboard</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <nav class="navbar">
            <div class="nav-left">
                <button class="back-btn-nav" id="backBtnNav" onclick="goBack()">‚Üê</button>
                <div class="nav-brand">
                    <div class="nav-logo">
                        <img src="TNC.jpg" alt="TNC" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiM4QjAwMDAiLz48dGV4dCB4PSIyMCIgeT0iMjAiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlROQzwvdGV4dD48L3N2Zz4=';">
                    </div>
                    <div>
                        <h2>THE NEW COLLEGE</h2>
                        <small>Est. 1951 | Chennai</small>
                    </div>
                </div>
            </div>
            <div class="nav-right">
                <button class="refresh-btn" onclick="refreshData()" title="Refresh data">‚Üª</button>
                <div class="menu-toggle" onclick="toggleMenu()">‚ò∞</div>
            </div>
        </nav>

        <!-- Full Page Menu -->
        <div class="menu-full" id="fullMenu">
            <div class="search-box">
                <input type="text" placeholder="Search" id="menuSearch" onkeyup="searchMenu(this.value)">
            </div>
            <div class="recent-section" id="recentSection">
                <div class="recent-header">
                    <h3>Recent</h3>
                    <span class="clear-all" onclick="clearRecent()">Clear all</span>
                </div>
                <div id="recentItems"></div>
            </div>
            <div class="menu-section">
                <h3>Menu</h3>
                <div class="menu-grid" id="menuGrid"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent"></div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')">
                <span>üè†</span>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="switchTab('menu')">
                <span>üìã</span>
                <span>Menu</span>
            </div>
            <div class="nav-item" onclick="switchTab('profile')">
                <span>üë§</span>
                <span>Profile</span>
            </div>
        </div>

        <!-- College Footer -->
        <div class="college-footer">
            <div class="arabic-footer">ÿ±Ÿéÿ®ŸêŸë ÿ≤ÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖÿßŸã</div>
            <div>THE NEW COLLEGE | Established 1951 | Affiliated to University of Madras</div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationIcon">‚ÑπÔ∏è</span>
        <span id="notificationMessage"></span>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDUdv62x0byBLjaTb9i2k_yB5-RVEF3s8M",
            authDomain: "attendance-app-dfa79.firebaseapp.com",
            projectId: "attendance-app-dfa79",
            storageBucket: "attendance-app-dfa79.firebasestorage.app",
            messagingSenderId: "713117014534",
            appId: "1:713117014534:web:56edbc2c1b88b0611a0187"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==================== APP STATE ====================
        let currentUser = null;
        let currentRole = 'student';
        let currentTab = 'home';
        let menuOpen = false;
        let recentItems = ['Library Go', 'Attendance', 'Fees', 'Feedback'];
        let selectedPeriod = 1;
        let selectedCourse = null;
        let attendanceData = {};
        let expandedPeriod = null;
        let studentsList = [];
        let staffList = [];
        let feedbackList = [];
        let libraryVisits = [];
        let selectedMonth = 'November';
        let selectedYear = 2025;

        // Navigation
        let navigationHistory = [];
        let currentPage = 'home';
        let refreshInterval = null;

        // ==================== STATIC DATA ====================
        const courses = [
            { id: 1, code: '20BJM608', name: 'Programming in ASP.NET', faculty: 'M M Syed Sulaiman', totalHours: 50 },
            { id: 2, code: '20BJM609', name: 'Operating Systems', faculty: 'N Anver Hussain', totalHours: 57 },
            { id: 3, code: '20BJMP607', name: 'Programming in ASP.NET PRACTICAL ‚Äì VII', faculty: 'Dr. S. SAKTHIVEL', totalHours: 65 },
            { id: 4, code: '20BJM610', name: 'Internet of Things', faculty: 'Dr. G NAJEEB AHMED', totalHours: 37 },
            { id: 5, code: '20BJMQ601', name: 'Mini Project', faculty: 'Dr. J. Abdul Rasheedh', totalHours: 35 }
        ];

        const adminUser = { email: 'admin@thenewcollege.in', password: 'admin', name: 'Administrator' };

        // ==================== FIREBASE LOADERS ====================
        async function loadStudents() {
            try {
                const snap = await db.collection('students').get();
                studentsList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log(`Loaded ${studentsList.length} students`);
            } catch (e) { console.error('loadStudents error', e); }
        }

        async function loadStaff() {
            try {
                const snap = await db.collection('staff').get();
                staffList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log(`Loaded ${staffList.length} staff`);
            } catch (e) { 
                staffList = [
                    { name: 'Dr. P. Hakkim Divan Mydeen', email: 'p.hakkimdivanmydeen@thenewcollege.edu.in', password: 'staff', department: 'Computer Science', designation: 'Professor' },
                    { name: 'Mr. S.A. Abdul Kadhar', email: 'sa.abdulkadhar@thenewcollege.edu.in', password: 'staff', department: 'Computer Science', designation: 'Assistant Professor' }
                ];
            }
        }

        async function loadAttendance() {
            try {
                const snap = await db.collection('attendance').get();
                const records = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    const key = `${d.studentId}_${d.date}_${d.period}`;
                    records[key] = d.status;
                    records[key+'_faculty'] = d.faculty || '';
                    records[key+'_course'] = d.course || '';
                    records[key+'_studentName'] = d.studentName || '';
                    records[key+'_timestamp'] = d.timestamp || '';
                });
                attendanceData = records;
                console.log(`Loaded ${Object.keys(records).filter(k => !k.includes('_')).length} attendance records`);
            } catch (e) { console.error('loadAttendance error', e); }
        }

        async function loadFeedbackForStaff() {
            if (currentRole !== 'staff') return;
            try {
                const snap = await db.collection('feedback').where('toStaffEmail', '==', currentUser.email).orderBy('timestamp', 'desc').get();
                feedbackList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.error(e); }
        }

        async function loadLibraryVisitsForStudent() {
            if (currentRole !== 'student') return;
            try {
                const snap = await db.collection('libraryVisits').where('studentId', '==', currentUser.reg).orderBy('checkInTime', 'desc').get();
                libraryVisits = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.error(e); }
        }

        // ==================== SAVE FUNCTIONS ====================
        async function saveAttendanceToFirebase(records) {
            showLoading();
            try {
                const batch = db.batch();
                records.forEach(r => {
                    const ref = db.collection('attendance').doc();
                    batch.set(ref, { ...r, timestamp: new Date().toISOString() });
                });
                await batch.commit();
                showNotification(`‚úÖ Saved ${records.length} records`, 'success');
                await loadAttendance();
            } catch (e) {
                console.error(e);
                showNotification('‚ùå Save failed', 'error');
            } finally { hideLoading(); }
        }

        async function saveFeedback(message, toStaffEmail, toStaffName) {
            try {
                await db.collection('feedback').add({
                    fromStudentId: currentUser.reg,
                    fromStudentName: currentUser.name,
                    toStaffEmail,
                    toStaffName,
                    message,
                    timestamp: new Date().toISOString(),
                    read: false
                });
                showNotification('Feedback sent', 'success');
            } catch (e) {
                console.error(e);
                showNotification('Error sending feedback', 'error');
            }
        }

        async function saveLibraryCheckIn() {
            try {
                await db.collection('libraryVisits').add({
                    studentId: currentUser.reg,
                    studentName: currentUser.name,
                    checkInTime: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0]
                });
                showNotification('Checked in to library', 'success');
                await loadLibraryVisitsForStudent();
                showLibraryGo();
            } catch (e) {
                console.error(e);
                showNotification('Check-in failed', 'error');
            }
        }

        async function saveLibraryCheckOut(visitId) {
            try {
                await db.collection('libraryVisits').doc(visitId).update({
                    checkOutTime: new Date().toISOString()
                });
                showNotification('Checked out', 'success');
                await loadLibraryVisitsForStudent();
                showLibraryGo();
            } catch (e) {
                console.error(e);
                showNotification('Check-out failed', 'error');
            }
        }

        async function addStudentsBulk(studentsArray) {
            const batch = db.batch();
            studentsArray.forEach(s => {
                const ref = db.collection('students').doc();
                batch.set(ref, s);
            });
            await batch.commit();
            showNotification(`Added ${studentsArray.length} students`, 'success');
            loadStudents();
        }

        async function addStaffBulk(staffArray) {
            const batch = db.batch();
            staffArray.forEach(s => {
                const ref = db.collection('staff').doc();
                batch.set(ref, s);
            });
            await batch.commit();
            showNotification(`Added ${staffArray.length} staff`, 'success');
            loadStaff();
        }

        // ==================== SESSION ====================
        function loadSession() {
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                currentRole = localStorage.getItem('currentRole') || 'student';
                Promise.all([
                    loadStudents(),
                    loadAttendance(),
                    currentRole === 'student' ? loadLibraryVisitsForStudent() : Promise.resolve(),
                    currentRole === 'staff' ? loadFeedbackForStaff() : Promise.resolve(),
                    currentRole === 'admin' ? loadStaff() : Promise.resolve()
                ]).then(() => {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    updateMenuForRole();
                    const page = localStorage.getItem('currentPage') || 'home';
                    currentPage = page;
                    if (page === 'home') {
                        if (currentRole === 'student') showStudentHome();
                        else if (currentRole === 'staff') showStaffDashboard();
                        else showAdminDashboard();
                    } else {
                        navigateTo(page);
                    }
                });
            }
        }

        function saveSession() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('currentRole', currentRole);
                localStorage.setItem('currentPage', currentPage);
            }
        }

        function clearSession() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentRole');
            localStorage.removeItem('currentPage');
            currentUser = null;
        }

        // ==================== LOGIN ====================
        function setRole(role) {
            currentRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('studentFields').style.display = role === 'student' ? 'block' : 'none';
            document.getElementById('staffAdminFields').style.display = role !== 'student' ? 'block' : 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            showLoading();
            if (currentRole === 'student') {
                const reg = document.getElementById('registerNumber').value.trim();
                const pwd = document.getElementById('password').value.trim();
                await loadStudents();
                const student = studentsList.find(s => s.reg === reg && (s.password === pwd || s.password === reg));
                if (student) {
                    currentUser = { reg: student.reg, name: student.name, role: 'student', batch: student.batch, semester: student.year };
                    saveSession();
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    await loadAttendance();
                    await loadLibraryVisitsForStudent();
                    updateMenuForRole();
                    currentPage = 'home';
                    showStudentHome();
                } else {
                    showNotification('Invalid credentials', 'error');
                }
            } else if (currentRole === 'staff') {
                const email = document.getElementById('email').value.trim();
                const pwd = document.getElementById('adminPassword').value.trim();
                await loadStaff();
                const staff = staffList.find(s => s.email === email && s.password === pwd);
                if (staff) {
                    currentUser = { ...staff, role: 'staff' };
                    saveSession();
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    await loadStudents();
                    await loadAttendance();
                    await loadFeedbackForStaff();
                    updateMenuForRole();
                    currentPage = 'home';
                    showStaffDashboard();
                } else {
                    showNotification('Invalid credentials', 'error');
                }
            } else if (currentRole === 'admin') {
                const email = document.getElementById('email').value.trim();
                const pwd = document.getElementById('adminPassword').value.trim();
                if (email === adminUser.email && pwd === adminUser.password) {
                    currentUser = { ...adminUser, role: 'admin' };
                    saveSession();
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    await loadStudents();
                    await loadStaff();
                    await loadAttendance();
                    updateMenuForRole();
                    currentPage = 'home';
                    showAdminDashboard();
                } else {
                    showNotification('Invalid admin', 'error');
                }
            }
            hideLoading();
        }

        // ==================== NAVIGATION ====================
        function navigateTo(section) {
            if (document.getElementById('fullMenu').classList.contains('open')) {
                document.getElementById('fullMenu').classList.remove('open');
                document.getElementById('mainContent').style.display = 'block';
            }
            if (currentPage !== section && currentPage !== 'home') {
                navigationHistory.push(currentPage);
            }
            currentPage = section;
            saveSession();
            document.getElementById('backBtnNav').classList.add('visible');
            switch (section) {
                case 'markAttendance': showMarkAttendance(); break;
                case 'attendance': showAttendance(); break;
                case 'myAccount': showProfile(); break;
                case 'departments': showDepartments(); break;
                case 'courses': showAllCourses(); break;
                case 'students': showStudentsList(); break;
                case 'faculty': showFacultyList(); break;
                case 'libraryGo': showLibraryGo(); break;
                case 'fees': showFees(); break;
                case 'feedback': showFeedbackPage(); break;
                case 'adminPanel': showAdminPanel(); break;
                default: showPlaceholder(section);
            }
        }

        function goBack() {
            if (navigationHistory.length > 0) {
                const prev = navigationHistory.pop();
                currentPage = prev;
                saveSession();
                if (prev === 'home') {
                    if (currentRole === 'student') showStudentHome();
                    else if (currentRole === 'staff') showStaffDashboard();
                    else showAdminDashboard();
                    document.getElementById('backBtnNav').classList.remove('visible');
                } else {
                    navigateTo(prev);
                }
            } else {
                currentPage = 'home';
                saveSession();
                if (currentRole === 'student') showStudentHome();
                else if (currentRole === 'staff') showStaffDashboard();
                else showAdminDashboard();
                document.getElementById('backBtnNav').classList.remove('visible');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            if (tab === 'home') {
                if (document.getElementById('fullMenu').classList.contains('open')) {
                    document.getElementById('fullMenu').classList.remove('open');
                    document.getElementById('mainContent').style.display = 'block';
                }
                navigationHistory = [];
                currentPage = 'home';
                expandedPeriod = null;
                document.getElementById('backBtnNav').classList.remove('visible');
                if (currentRole === 'student') showStudentHome();
                else if (currentRole === 'staff') showStaffDashboard();
                else showAdminDashboard();
            } else if (tab === 'menu') {
                toggleMenu();
            } else if (tab === 'profile') {
                navigateTo('myAccount');
            }
        }

        function toggleMenu() {
            menuOpen = !menuOpen;
            document.getElementById('fullMenu').classList.toggle('open', menuOpen);
            document.getElementById('mainContent').style.display = menuOpen ? 'none' : 'block';
        }

        function updateMenuForRole() {
            const grid = document.getElementById('menuGrid');
            if (currentRole === 'student') {
                grid.innerHTML = `
                    <div class="menu-grid-item" onclick="navigateTo('libraryGo')"><span>üìö</span><span>Library Go</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('attendance')"><span>‚úÖ</span><span>Attendance</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('fees')"><span>üí∞</span><span>Fees</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('myAccount')"><span>üë§</span><span>My Account</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('feedback')"><span>üí¨</span><span>Give Feedback</span></div>
                `;
            } else if (currentRole === 'staff') {
                grid.innerHTML = `
                    <div class="menu-grid-item" onclick="navigateTo('markAttendance')"><span>‚úÖ</span><span>Mark Attendance</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('departments')"><span>üèõÔ∏è</span><span>Departments</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('courses')"><span>üìö</span><span>All Courses</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('students')"><span>üë•</span><span>Students List</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('faculty')"><span>üë®‚Äçüè´</span><span>Faculty List</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('feedback')"><span>üí¨</span><span>Feedback Received</span></div>
                    <div class="menu-grid-item" onclick="testConnection()"><span>üîå</span><span>Test Firebase</span></div>
                `;
            } else {
                grid.innerHTML = `
                    <div class="menu-grid-item" onclick="navigateTo('adminPanel')"><span>‚öôÔ∏è</span><span>Admin Panel</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('students')"><span>üë•</span><span>Students List</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('faculty')"><span>üë®‚Äçüè´</span><span>Faculty List</span></div>
                    <div class="menu-grid-item" onclick="navigateTo('attendance')"><span>‚úÖ</span><span>Attendance</span></div>
                    <div class="menu-grid-item" onclick="testConnection()"><span>üîå</span><span>Test Firebase</span></div>
                `;
            }
        }

        // ==================== STUDENT HOME ====================
        function showStudentHome() {
            const content = document.getElementById('mainContent');
            const today = new Date().toISOString().split('T')[0];
            const studentId = currentUser.reg;
            const periodDetails = {};
            for (let h=1; h<=5; h++) {
                const key = `${studentId}_${today}_${h}`;
                periodDetails[h] = attendanceData[key] || null;
            }

            let hoursHTML = '<div class="hours-grid">';
            for (let h=1; h<=5; h++) {
                const status = periodDetails[h];
                hoursHTML += `<div class="hour-box ${status||''}" onclick="showPeriodDetail(${h})">
                    <div class="hour">${h} hr</div>
                    <div class="status">${status ? getStatusText(status) : 'Not Marked'}</div>
                </div>`;
            }
            hoursHTML += '</div>';

            let periodDetailHTML = '';
            if (expandedPeriod && periodDetails[expandedPeriod]) {
                const key = `${studentId}_${today}_${expandedPeriod}`;
                periodDetailHTML = `
                    <div class="period-detail-card">
                        <div class="period-detail-header">
                            <h3>Class - Hour ${expandedPeriod}</h3>
                            <span class="period-time">${getPeriodTime(expandedPeriod)}</span>
                        </div>
                        <div class="period-detail-content">
                            <div class="period-detail-row"><span class="period-detail-label">Faculty:</span><span class="period-detail-value faculty">${attendanceData[key+'_faculty'] || 'Not assigned'}</span></div>
                            <div class="period-detail-row"><span class="period-detail-label">Status:</span><span class="period-detail-value status ${periodDetails[expandedPeriod]}">${getStatusText(periodDetails[expandedPeriod])}</span></div>
                            <div class="period-detail-course"><h4>${attendanceData[key+'_course'] || 'No course'}</h4></div>
                        </div>
                    </div>
                `;
            } else if (expandedPeriod) {
                periodDetailHTML = `<div class="period-detail-card"><p style="text-align:center;">No attendance marked for this period</p></div>`;
            }

            const allRecords = Object.keys(attendanceData).filter(k => 
                k.startsWith(studentId) && 
                !k.includes('_faculty') && 
                !k.includes('_course') && 
                !k.includes('_studentName') && 
                !k.includes('_timestamp')
            );
            const total = allRecords.length;
            const present = allRecords.filter(k => attendanceData[k] === 'present').length;
            const percent = total ? Math.round(present/total*100) : 0;

            content.innerHTML = `
                <div class="student-home">
                    <div class="student-header">
                        <h1>${currentUser.name}</h1>
                        <p>Admission No : ${currentUser.reg}</p>
                        <p>Batch : ${currentUser.batch} | Year : ${currentUser.semester}</p>
                    </div>
                    ${hoursHTML}
                    ${periodDetailHTML}
                    <div class="view-all-link"><a href="#" onclick="navigateTo('attendance'); return false;">View all attendance records ‚Üí</a></div>
                    <div class="feedback-section">
                        <p>Every feedback is valuable.</p>
                        <button class="feedback-btn" onclick="navigateTo('feedback')">Give Feedback</button>
                    </div>
                    <div class="semester-card">
                        <div class="card-header"><h3>Attendance Summary</h3><a href="#" class="see-all" onclick="navigateTo('attendance'); return false;">See All ‚Üí</a></div>
                        <div>
                            <h4>Current Semester</h4>
                            <div class="semester-stats">
                                <div class="stats-details">
                                    <div class="stat-row"><span class="stat-label">Total Classes</span><span class="stat-value">${total}</span></div>
                                    <div class="stat-row"><span class="stat-label">Present</span><span class="stat-value">${present}</span></div>
                                </div>
                                <div class="percentage-circle">${percent}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showPeriodDetail(hour) {
            expandedPeriod = expandedPeriod === hour ? null : hour;
            showStudentHome();
        }

        function getStatusText(s) {
            return s==='present'?'‚úì Present': s==='absent'?'‚úó Absent': s==='late'?'‚è∞ Late': s==='letoff'?'‚òë Let-off':'';
        }

        function getPeriodTime(p) {
            const t = {1:'09:00-10:00',2:'10:00-11:00',3:'11:00-12:00',4:'12:00-13:00',5:'14:00-15:00'};
            return t[p]||'';
        }

        // ==================== STAFF DASHBOARD ====================
        function showStaffDashboard() {
            const unread = feedbackList.filter(f => !f.read).length;
            document.getElementById('mainContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-title">Students</div><div class="stat-value">${studentsList.length}</div></div>
                    <div class="stat-card"><div class="stat-title">Unread Feedback</div><div class="stat-value">${unread}</div></div>
                    <div class="stat-card"><div class="stat-title">Courses</div><div class="stat-value">${courses.length}</div></div>
                    <div class="stat-card"><div class="stat-title">Today</div><div class="stat-value">${new Date().toLocaleDateString()}</div></div>
                </div>
                <div style="background:#f8f9fa; border-radius:15px; padding:20px; margin:20px 0;">
                    <h3 style="color:#8B0000;">üìã Recent Feedback</h3>
                    ${feedbackList.slice(0,3).map(f => `
                        <div class="feedback-item ${!f.read?'unread':''}">
                            <div class="feedback-meta">From: ${f.fromStudentName} ¬∑ ${new Date(f.timestamp).toLocaleString()}</div>
                            <div class="feedback-message">${f.message}</div>
                        </div>
                    `).join('') || '<p>No feedback yet.</p>'}
                </div>
                <div class="table-container" style="background:white; border-radius:15px; padding:20px;">
                    <div class="table-header"><h3>Quick Actions</h3></div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:10px;">
                        <button class="btn-primary" onclick="navigateTo('markAttendance')">‚úÖ Mark Attendance</button>
                        <button class="btn-primary" onclick="navigateTo('feedback')">üí¨ View All Feedback</button>
                        <button class="btn-primary" onclick="navigateTo('students')">üë• Students List</button>
                        <button class="btn-primary" onclick="navigateTo('faculty')">üë®‚Äçüè´ Faculty List</button>
                        <button class="btn-primary" onclick="exportAttendance()">üì• Export</button>
                    </div>
                </div>
            `;
        }

        // ==================== ADMIN DASHBOARD ====================
        function showAdminDashboard() {
            document.getElementById('mainContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-title">Students</div><div class="stat-value">${studentsList.length}</div></div>
                    <div class="stat-card"><div class="stat-title">Staff</div><div class="stat-value">${staffList.length}</div></div>
                    <div class="stat-card"><div class="stat-title">Courses</div><div class="stat-value">${courses.length}</div></div>
                </div>
                <div class="table-container" style="background:white; border-radius:15px; padding:20px;">
                    <div class="table-header"><h3>Admin Actions</h3></div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:10px;">
                        <button class="btn-primary" onclick="navigateTo('adminPanel')">‚öôÔ∏è Admin Panel</button>
                        <button class="btn-primary" onclick="navigateTo('students')">üë• Students List</button>
                        <button class="btn-primary" onclick="navigateTo('faculty')">üë®‚Äçüè´ Faculty List</button>
                    </div>
                </div>
            `;
        }

        // ==================== ADMIN PANEL ====================
        function showAdminPanel() {
            document.getElementById('mainContent').innerHTML = `
                <div class="admin-section">
                    <h2 style="color:#8B0000;">‚ûï Add Student (Single)</h2>
                    <div class="admin-form">
                        <input type="text" id="newStudentReg" placeholder="Register Number">
                        <input type="text" id="newStudentName" placeholder="Full Name">
                        <input type="text" id="newStudentPassword" placeholder="Password (default = reg no)" value="">
                        <input type="text" id="newStudentBatch" placeholder="Batch (A/B)">
                        <input type="text" id="newStudentYear" placeholder="Year (1st/2nd/3rd)">
                        <button class="btn-primary" onclick="addStudentFromForm()">Add Student</button>
                    </div>
                </div>
                <div class="admin-section">
                    <h2 style="color:#8B0000;">‚ûï Add Staff (Single)</h2>
                    <div class="admin-form">
                        <input type="text" id="newStaffName" placeholder="Full Name">
                        <input type="email" id="newStaffEmail" placeholder="Email">
                        <input type="text" id="newStaffPassword" placeholder="Password">
                        <input type="text" id="newStaffDept" placeholder="Department">
                        <input type="text" id="newStaffDesig" placeholder="Designation">
                        <button class="btn-primary" onclick="addStaffFromForm()">Add Staff</button>
                    </div>
                </div>
                <div class="admin-section">
                    <h2 style="color:#8B0000;">üìÅ Bulk Upload Students</h2>
                    <div class="bulk-upload-area">
                        <p>Upload a CSV file with headers: <code>reg, name, password, batch, year</code></p>
                        <input type="file" id="studentBulkFile" accept=".csv">
                        <button class="btn-primary" onclick="uploadStudentBulk()">Upload Students</button>
                        <button class="btn-primary" style="background:#28a745;" onclick="downloadSampleStudentCSV()">Download Sample CSV</button>
                    </div>
                </div>
                <div class="admin-section">
                    <h2 style="color:#8B0000;">üìÅ Bulk Upload Staff</h2>
                    <div class="bulk-upload-area">
                        <p>Upload a CSV file with headers: <code>name, email, password, department, designation</code></p>
                        <input type="file" id="staffBulkFile" accept=".csv">
                        <button class="btn-primary" onclick="uploadStaffBulk()">Upload Staff</button>
                        <button class="btn-primary" style="background:#28a745;" onclick="downloadSampleStaffCSV()">Download Sample CSV</button>
                    </div>
                </div>
            `;
        }

        // Bulk upload handlers
        window.uploadStudentBulk = function() {
            const fileInput = document.getElementById('studentBulkFile');
            if (!fileInput.files.length) { showNotification('Select a file', 'error'); return; }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(l => l.trim());
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const students = [];
                for (let i=1; i<lines.length; i++) {
                    const vals = lines[i].split(',').map(v => v.trim());
                    if (vals.length >= 2) {
                        const student = {
                            reg: vals[headers.indexOf('reg')] || '',
                            name: vals[headers.indexOf('name')] || '',
                            password: vals[headers.indexOf('password')] || vals[headers.indexOf('reg')] || '',
                            batch: vals[headers.indexOf('batch')] || 'A',
                            year: vals[headers.indexOf('year')] || '1st'
                        };
                        if (student.reg && student.name) students.push(student);
                    }
                }
                if (students.length) {
                    addStudentsBulk(students);
                } else {
                    showNotification('No valid student data', 'error');
                }
            };
            reader.readAsText(file);
        };

        window.uploadStaffBulk = function() {
            const fileInput = document.getElementById('staffBulkFile');
            if (!fileInput.files.length) { showNotification('Select a file', 'error'); return; }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(l => l.trim());
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const staff = [];
                for (let i=1; i<lines.length; i++) {
                    const vals = lines[i].split(',').map(v => v.trim());
                    if (vals.length >= 3) {
                        const s = {
                            name: vals[headers.indexOf('name')] || '',
                            email: vals[headers.indexOf('email')] || '',
                            password: vals[headers.indexOf('password')] || '',
                            department: vals[headers.indexOf('department')] || '',
                            designation: vals[headers.indexOf('designation')] || ''
                        };
                        if (s.name && s.email && s.password) staff.push(s);
                    }
                }
                if (staff.length) {
                    addStaffBulk(staff);
                } else {
                    showNotification('No valid staff data', 'error');
                }
            };
            reader.readAsText(file);
        };

        window.downloadSampleStudentCSV = function() {
            const csv = `reg,name,password,batch,year\n2313181058101,M Abdul Muquthadir,2313181058101,B,3rd\n2313181058102,Abrar S,2313181058102,B,3rd`;
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_students.csv';
            a.click();
            URL.revokeObjectURL(url);
        };

        window.downloadSampleStaffCSV = function() {
            const csv = `name,email,password,department,designation\nDr. P. Hakkim Divan Mydeen,p.hakkimdivanmydeen@thenewcollege.edu.in,staff,Computer Science,Professor\nMr. S.A. Abdul Kadhar,sa.abdulkadhar@thenewcollege.edu.in,staff,Computer Science,Assistant Professor`;
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_staff.csv';
            a.click();
            URL.revokeObjectURL(url);
        };

        window.addStudentFromForm = async function() {
            const reg = document.getElementById('newStudentReg').value.trim();
            const name = document.getElementById('newStudentName').value.trim();
            const pwd = document.getElementById('newStudentPassword').value.trim() || reg;
            const batch = document.getElementById('newStudentBatch').value.trim() || 'A';
            const year = document.getElementById('newStudentYear').value.trim() || '1st';
            if (!reg || !name) { showNotification('Register No and Name required', 'error'); return; }
            await addStudentsBulk([{ reg, name, password: pwd, batch, year }]);
            document.getElementById('newStudentReg').value = '';
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentPassword').value = '';
            document.getElementById('newStudentBatch').value = '';
            document.getElementById('newStudentYear').value = '';
        };

        window.addStaffFromForm = async function() {
            const name = document.getElementById('newStaffName').value.trim();
            const email = document.getElementById('newStaffEmail').value.trim();
            const pwd = document.getElementById('newStaffPassword').value.trim();
            const dept = document.getElementById('newStaffDept').value.trim();
            const desig = document.getElementById('newStaffDesig').value.trim();
            if (!name || !email || !pwd) { showNotification('Name, email and password required', 'error'); return; }
            await addStaffBulk([{ name, email, password: pwd, department: dept, designation: desig }]);
            document.getElementById('newStaffName').value = '';
            document.getElementById('newStaffEmail').value = '';
            document.getElementById('newStaffPassword').value = '';
            document.getElementById('newStaffDept').value = '';
            document.getElementById('newStaffDesig').value = '';
        };

        // ==================== FEEDBACK ====================
        function showFeedbackPage() {
            if (currentRole === 'student') {
                const staffOptions = staffList.map(s => `<option value="${s.email}">${s.name} (${s.department || ''})</option>`).join('');
                document.getElementById('mainContent').innerHTML = `
                    <div style="background:white; border-radius:20px; padding:20px; max-width:600px; margin:0 auto;">
                        <h2 style="color:#8B0000;">Give Feedback to Staff</h2>
                        <div class="input-group">
                            <label>Select Staff</label>
                            <select id="feedbackStaffEmail">${staffOptions}</select>
                        </div>
                        <div class="input-group">
                            <label>Your Feedback</label>
                            <textarea id="feedbackMessage" placeholder="Write your feedback..."></textarea>
                        </div>
                        <button class="btn-primary" onclick="submitFeedback()">Send Feedback</button>
                    </div>
                `;
            } else if (currentRole === 'staff') {
                let html = '<div style="background:white; border-radius:20px; padding:20px;"><h2 style="color:#8B0000;">Feedback Received</h2>';
                if (feedbackList.length === 0) html += '<p>No feedback yet.</p>';
                else {
                    feedbackList.forEach(f => {
                        html += `
                            <div class="feedback-item ${!f.read?'unread':''}" data-id="${f.id}">
                                <div class="feedback-meta">From: ${f.fromStudentName} ¬∑ ${new Date(f.timestamp).toLocaleString()}</div>
                                <div class="feedback-message">${f.message}</div>
                                <button class="btn-primary" style="margin-top:10px; padding:5px 10px; font-size:12px;" onclick="markFeedbackRead('${f.id}')">Mark as read</button>
                            </div>
                        `;
                    });
                }
                html += '</div>';
                document.getElementById('mainContent').innerHTML = html;
            }
        }

        window.submitFeedback = async function() {
            const staffEmail = document.getElementById('feedbackStaffEmail').value;
            const msg = document.getElementById('feedbackMessage').value.trim();
            if (!msg) { showNotification('Please enter feedback', 'error'); return; }
            const staff = staffList.find(s => s.email === staffEmail);
            await saveFeedback(msg, staffEmail, staff ? staff.name : 'Staff');
            document.getElementById('feedbackMessage').value = '';
            showNotification('Feedback sent', 'success');
        };

        window.markFeedbackRead = async function(id) {
            try {
                await db.collection('feedback').doc(id).update({ read: true });
                await loadFeedbackForStaff();
                showFeedbackPage();
            } catch (e) {
                console.error(e);
                showNotification('Error', 'error');
            }
        };

        // ==================== LIBRARY GO ====================
        async function showLibraryGo() {
            await loadLibraryVisitsForStudent();
            const activeVisit = libraryVisits.find(v => !v.checkOutTime);
            let html = `
                <div class="library-page">
                    <h2 style="color:#8B0000;">üìö Library Go</h2>
                    <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin:20px 0;">
            `;
            if (activeVisit) {
                const checkIn = new Date(activeVisit.checkInTime).toLocaleString();
                html += `
                    <p>You checked in at: <strong>${checkIn}</strong></p>
                    <button class="btn-primary checkout-btn" onclick="checkOutLibrary('${activeVisit.id}')">üö™ Check Out</button>
                `;
            } else {
                html += `<button class="btn-primary checkin-btn" onclick="checkInLibrary()">üì• Check In</button>`;
            }
            html += `</div><h3>Your Recent Visits</h3>`;
            if (libraryVisits.length === 0) html += '<p>No visits recorded.</p>';
            else {
                html += '<ul style="list-style:none;">';
                libraryVisits.slice(0,10).forEach(v => {
                    const inTime = new Date(v.checkInTime).toLocaleString();
                    const outTime = v.checkOutTime ? new Date(v.checkOutTime).toLocaleString() : 'Still inside';
                    let duration = '';
                    if (v.checkOutTime) {
                        const diff = new Date(v.checkOutTime) - new Date(v.checkInTime);
                        const mins = Math.floor(diff / 60000);
                        const hours = Math.floor(mins / 60);
                        const remainingMins = mins % 60;
                        duration = ` (${hours}h ${remainingMins}m)`;
                    }
                    html += `<li style="background:#eee; padding:10px; margin:5px 0; border-radius:5px;">üìÖ ${inTime} ‚Üí ${outTime}${duration}</li>`;
                });
                html += '</ul>';
            }
            html += '</div>';
            document.getElementById('mainContent').innerHTML = html;
        }

        window.checkInLibrary = saveLibraryCheckIn;
        window.checkOutLibrary = saveLibraryCheckOut;

        // ==================== FEES (UPDATED) ====================
        function showFees() {
            const feeAmount = 25000;
            const upiId = "thenewcollege@okhdfcbank"; // Replace with actual UPI ID
            const gpayLink = `tez://upi/pay?pa=${upiId}&pn=THE%20NEW%20COLLEGE&am=${feeAmount}&tn=Fees`;
            const phonepayLink = `phonepe://pay?pa=${upiId}&pn=THE%20NEW%20COLLEGE&am=${feeAmount}&mode=pg`;

            document.getElementById('mainContent').innerHTML = `
                <div class="fees-page">
                    <h2 style="color:#8B0000;">üí∞ Semester Fees</h2>
                    <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin:20px 0;">
                        <p style="font-size:24px; font-weight:bold;">‚Çπ ${feeAmount.toLocaleString()}</p>
                        <p>Due Date: 15 March 2026</p>
                    </div>
                    <h3>Pay via</h3>
                    <div class="payment-options">
                        <button class="payment-btn gpay" onclick="openPaymentLink('${gpayLink}')">üì± GPay</button>
                        <button class="payment-btn phonepay" onclick="openPaymentLink('${phonepayLink}')">üì≤ PhonePe</button>
                        <button class="payment-btn card" onclick="showCardForm()">üí≥ Card</button>
                    </div>
                    <div id="paymentMessage" style="margin-top:20px;"></div>
                    <div id="cardPaymentForm" style="display:none;" class="card-payment-form">
                        <h4>Enter Card Details</h4>
                        <input type="text" placeholder="Card Number" maxlength="16">
                        <input type="text" placeholder="Expiry (MM/YY)">
                        <input type="text" placeholder="CVV" maxlength="3">
                        <input type="text" placeholder="Name on Card">
                        <button class="btn-primary" onclick="simulateCardPayment()">Pay ‚Çπ${feeAmount}</button>
                    </div>
                    <div class="upi-id" style="margin-top:20px;">
                        <strong>UPI ID:</strong> ${upiId}
                    </div>
                </div>
            `;
        }

        window.openPaymentLink = function(link) {
            window.location.href = link;
            setTimeout(() => {
                showNotification('If the app did not open, use UPI ID: then', 'info');
            }, 500);
        };

        window.showCardForm = function() {
            const form = document.getElementById('cardPaymentForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        };

        window.simulateCardPayment = function() {
            showNotification('Card payment simulation successful (demo)', 'success');
            document.getElementById('cardPaymentForm').style.display = 'none';
        };

        // ==================== ATTENDANCE VIEWS (Hourly & Termly) ====================
        function showAttendance() {
            document.getElementById('mainContent').innerHTML = `
                <div class="attendance-page">
                    <div class="attendance-tabs">
                        <button class="attendance-tab active" onclick="showAttendanceCourse()">Course</button>
                        <button class="attendance-tab" onclick="showAttendanceHourly()">Hourly</button>
                        <button class="attendance-tab" onclick="showAttendanceTermly()">Termly</button>
                    </div>
                    <div id="attendanceContent">${getAttendanceCourseHTML()}</div>
                </div>
            `;
        }

        function getAttendanceCourseHTML() {
            const studentId = currentUser.reg;
            // Group attendance by course (we don't have direct course mapping, so we'll show per course based on stored course field)
            const courseStats = {};
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(studentId) && !key.includes('_')) {
                    const course = attendanceData[key+'_course'] || 'Unknown';
                    if (!courseStats[course]) courseStats[course] = { total: 0, present: 0 };
                    courseStats[course].total++;
                    if (attendanceData[key] === 'present') courseStats[course].present++;
                }
            });
            let html = '<div class="course-list">';
            for (let [course, stats] of Object.entries(courseStats)) {
                const percent = stats.total ? Math.round(stats.present/stats.total*100) : 0;
                html += `
                    <div class="course-item">
                        <h3>${course}</h3>
                        <div class="course-stats">
                            <span>Total: ${stats.total}</span>
                            <span>Attended: ${stats.present}</span>
                            <span>Percentage: ${percent}%</span>
                        </div>
                    </div>
                `;
            }
            if (Object.keys(courseStats).length === 0) {
                html += '<p>No attendance records found.</p>';
            }
            html += '</div>';
            return html;
        }

        window.showAttendanceCourse = function() {
            document.querySelectorAll('.attendance-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('attendanceContent').innerHTML = getAttendanceCourseHTML();
        };

        window.showAttendanceHourly = function() {
            document.querySelectorAll('.attendance-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            const studentId = currentUser.reg;
            const months = [
                { name:'November', year:2025, month:11, days:30 },
                { name:'December', year:2025, month:12, days:31 },
                { name:'January', year:2026, month:1, days:31 },
                { name:'February', year:2026, month:2, days:28 }
            ];
            const cur = months.find(m => m.name === selectedMonth) || months[0];
            let html = `<div class="month-grid">`;
            months.forEach(m => html += `<button class="month-btn ${m.name===selectedMonth?'active':''}" onclick="selectMonth('${m.name}')">${m.name}</button>`);
            html += `</div><table class="attendance-table"><tr><th>Day</th><th>H1</th><th>H2</th><th>H3</th><th>H4</th><th>H5</th></tr>`;
            for (let d=1; d<=cur.days; d++) {
                const date = `${cur.year}-${String(cur.month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                html += `<tr><td>${d}</td>`;
                for (let h=1; h<=5; h++) {
                    const key = `${studentId}_${date}_${h}`;
                    const status = attendanceData[key] || 'unmarked';
                    html += `<td class="status-${status}">${getStatusSymbol(status)}</td>`;
                }
                html += `</tr>`;
            }
            html += `</table><div class="status-buttons">` +
                `<span class="status-btn present">‚úÖ Present</span>` +
                `<span class="status-btn absent">‚ùå Absent</span>` +
                `<span class="status-btn late">‚è∞ Late</span>` +
                `<span class="status-btn letoff">‚òë Let-off</span>` +
                `<span class="status-btn unmarked">‚óª Unmarked</span>` +
            `</div>`;
            document.getElementById('attendanceContent').innerHTML = html;
        };

        window.selectMonth = function(month) {
            selectedMonth = month;
            showAttendanceHourly();
        };

        window.showAttendanceTermly = function() {
            document.querySelectorAll('.attendance-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            const studentId = currentUser.reg;
            const months = [
                { name:'Nov', year:2025, month:11, days:30 },
                { name:'Dec', year:2025, month:12, days:31 },
                { name:'Jan', year:2026, month:1, days:31 }
            ];
            let totalAttended = 0, totalClasses = 0;
            const monthData = months.map((m, idx) => {
                let attended = 0, total = 0;
                for (let d=1; d<=m.days; d++) {
                    const date = `${m.year}-${String(m.month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    for (let h=1; h<=5; h++) {
                        const key = `${studentId}_${date}_${h}`;
                        if (attendanceData[key]) {
                            total++; totalClasses++;
                            if (attendanceData[key] === 'present') { attended++; totalAttended++; }
                        }
                    }
                }
                const p = total ? Math.round(attended/total*100) : 0;
                return { sl: idx+1, year: m.year, month: m.name, attended, total, percent: p };
            });
            const overallPercent = totalClasses ? Math.round(totalAttended/totalClasses*100) : 0;
            let html = `<div class="term-stats"><div class="term-header"><h3>Semester-6</h3><span>${overallPercent}%</span></div>`;
            html += `<div class="term-period">Term<br>19-11-2025 To 15-04-2026</div>`;
            html += `<table class="term-table"><tr><th>SI</th><th>Year</th><th>Month</th><th>Attended</th><th>Total</th><th>%</th></tr>`;
            monthData.forEach(m => {
                html += `<tr><td>${m.sl}</td><td>${m.year}</td><td>${m.month}</td><td>${m.attended}</td><td>${m.total}</td><td>${m.percent}</td></tr>`;
            });
            html += `<tr><td colspan="3"><strong>Total</strong></td><td><strong>${totalAttended}</strong></td><td><strong>${totalClasses}</strong></td><td><strong>${overallPercent}</strong></td></tr>`;
            html += `</table></div>`;
            document.getElementById('attendanceContent').innerHTML = html;
        };

        function getStatusSymbol(s) {
            if (s==='present') return '‚úÖ';
            if (s==='absent') return '‚ùå';
            if (s==='late') return '‚è∞';
            if (s==='letoff') return '‚òë';
            return '‚óª';
        }

        // ==================== MARK ATTENDANCE ====================
        async function showMarkAttendance() {
            const content = document.getElementById('mainContent');
            const today = new Date().toISOString().split('T')[0];
            if (studentsList.length === 0) await loadStudents();
            if (studentsList.length === 0) {
                content.innerHTML = `<div style="text-align:center; padding:50px;"><h3>No Students Found</h3></div>`;
                return;
            }
            content.innerHTML = `
                <div class="mark-attendance-page">
                    <h2 style="color:#8B0000;">Mark Attendance</h2>
                    <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px;">
                        <p>Date: ${new Date().toLocaleDateString('en-US',{weekday:'long', year:'numeric', month:'long', day:'numeric'})}</p>
                        <p>Total Students: ${studentsList.length}</p>
                    </div>
                    <div class="period-selector">
                        <h3>Select Period</h3>
                        <div class="period-grid">
                            ${[1,2,3,4,5].map(p => `<div class="period-card ${selectedPeriod===p?'selected':''}" onclick="selectPeriod(${p})"><div class="period-number">Period ${p}</div><div class="period-time">${getPeriodTime(p)}</div></div>`).join('')}
                        </div>
                    </div>
                    <div class="course-selector">
                        <h3>Select Course</h3>
                        <select class="course-select" onchange="selectCourse(this.value)">
                            <option value="">Choose a course...</option>
                            ${courses.map(c => `<option value="${c.id}" ${selectedCourse==c.id?'selected':''}>${c.code} - ${c.name}</option>`).join('')}
                        </select>
                    </div>
                    ${selectedCourse ? `
                        <div class="mark-all-section">
                            <h3>Quick Mark All</h3>
                            <div class="mark-all-buttons">
                                <button class="mark-all-btn present" onclick="markAllStudents('present')">‚úÖ All Present</button>
                                <button class="mark-all-btn absent" onclick="markAllStudents('absent')">‚ùå All Absent</button>
                                <button class="mark-all-btn late" onclick="markAllStudents('late')">‚è∞ All Late</button>
                                <button class="mark-all-btn letoff" onclick="markAllStudents('letoff')">‚òë All Let-off</button>
                            </div>
                        </div>
                        <div class="student-list">
                            <div class="student-list-header"><h3>Students (${studentsList.length})</h3><input type="text" placeholder="Search..." onkeyup="searchStudents(this.value)"></div>
                            <div id="studentListContainer">
                                ${studentsList.map(s => {
                                    const key = `${s.reg}_${today}_${selectedPeriod}`;
                                    const status = attendanceData[key] || 'unmarked';
                                    return `
                                        <div class="student-list-item" id="student-${s.reg}">
                                            <div class="student-info"><h4>${s.name}</h4><p>${s.reg} | Batch: ${s.batch||'A'} | Year: ${s.year||'1st'}</p></div>
                                            <div class="student-status">
                                                <div class="status-option present ${status==='present'?'active':''}" onclick="setStudentStatus('${s.reg}','present')">‚úì</div>
                                                <div class="status-option absent ${status==='absent'?'active':''}" onclick="setStudentStatus('${s.reg}','absent')">‚úó</div>
                                                <div class="status-option late ${status==='late'?'active':''}" onclick="setStudentStatus('${s.reg}','late')">‚è∞</div>
                                                <div class="status-option letoff ${status==='letoff'?'active':''}" onclick="setStudentStatus('${s.reg}','letoff')">‚òë</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="submit-attendance">
                            <button class="cancel-btn" onclick="resetAttendance()">Reset</button>
                            <button class="submit-btn" onclick="submitAttendance()">Submit Attendance</button>
                        </div>
                    ` : `<div style="text-align:center; padding:50px;">Please select a course.</div>`}
                </div>
            `;
        }

        window.selectPeriod = function(p) { selectedPeriod = p; showMarkAttendance(); };
        window.selectCourse = function(id) { selectedCourse = parseInt(id); showMarkAttendance(); };
        window.searchStudents = function(q) {
            document.querySelectorAll('.student-list-item').forEach(el => {
                const text = el.innerText.toLowerCase();
                el.style.display = text.includes(q.toLowerCase()) ? 'flex' : 'none';
            });
        };
        window.setStudentStatus = function(reg, status) {
            if (!selectedCourse) return;
            const today = new Date().toISOString().split('T')[0];
            attendanceData[`${reg}_${today}_${selectedPeriod}`] = status;
            const div = document.getElementById(`student-${reg}`);
            if (div) {
                div.querySelectorAll('.status-option').forEach(o => o.classList.remove('active'));
                div.querySelector(`.status-option.${status}`).classList.add('active');
            }
        };
        window.markAllStudents = function(status) {
            if (!selectedCourse) return;
            const today = new Date().toISOString().split('T')[0];
            studentsList.forEach(s => {
                attendanceData[`${s.reg}_${today}_${selectedPeriod}`] = status;
                const div = document.getElementById(`student-${s.reg}`);
                if (div) {
                    div.querySelectorAll('.status-option').forEach(o => o.classList.remove('active'));
                    div.querySelector(`.status-option.${status}`).classList.add('active');
                }
            });
        };
        window.resetAttendance = function() {
            if (!selectedCourse) return;
            const today = new Date().toISOString().split('T')[0];
            studentsList.forEach(s => delete attendanceData[`${s.reg}_${today}_${selectedPeriod}`]);
            showMarkAttendance();
        };
        window.submitAttendance = async function() {
            if (!selectedCourse) return;
            const today = new Date().toISOString().split('T')[0];
            const courseObj = courses.find(c => c.id === selectedCourse);
            const records = [];
            studentsList.forEach(s => {
                const key = `${s.reg}_${today}_${selectedPeriod}`;
                const status = attendanceData[key];
                if (status && status !== 'unmarked') {
                    records.push({
                        date: today,
                        studentId: s.reg,
                        studentName: s.name,
                        period: selectedPeriod,
                        status: status,
                        faculty: currentUser.name,
                        course: courseObj ? `${courseObj.code} - ${courseObj.name}` : 'Course'
                    });
                }
            });
            if (records.length === 0) { showNotification('No attendance marked', 'info'); return; }
            await saveAttendanceToFirebase(records);
            selectedCourse = null;
            showMarkAttendance();
        };

        // ==================== MISC ====================
        function showProfile() {
            document.getElementById('mainContent').innerHTML = `
                <div style="background:white; border-radius:20px; padding:20px; max-width:500px; margin:0 auto;">
                    <div style="width:80px; height:80px; background:#8B0000; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:32px; margin:0 auto 15px;">
                        ${currentUser.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()}
                    </div>
                    <h2 style="text-align:center;">${currentUser.name}</h2>
                    <p style="text-align:center;">${currentUser.role==='student'?'Register No: '+currentUser.reg:'Staff Member'}</p>
                    ${currentUser.role==='student'?`<p style="text-align:center;">Batch: ${currentUser.batch} | Year: ${currentUser.semester}</p>`:''}
                    <button class="btn-primary" style="width:100%; margin-top:20px;" onclick="logout()">Logout</button>
                </div>
            `;
        }

        function showDepartments() { document.getElementById('mainContent').innerHTML = '<div style="background:white; padding:20px;"><h2>Departments</h2><p>List coming soon.</p></div>'; }
        function showAllCourses() { document.getElementById('mainContent').innerHTML = '<div style="background:white; padding:20px;"><h2>All Courses</h2><p>List coming soon.</p></div>'; }
        function showStudentsList() {
            if (studentsList.length === 0) { document.getElementById('mainContent').innerHTML = '<div style="background:white; padding:20px;"><h2>No students</h2></div>'; return; }
            let html = '<div style="background:white; padding:20px;"><h2>Students List</h2><table style="width:100%; border-collapse:collapse;"><tr><th>#</th><th>Reg No</th><th>Name</th><th>Batch</th><th>Year</th></tr>';
            studentsList.forEach((s,i) => {
                html += `<tr><td>${i+1}</td><td>${s.reg}</td><td>${s.name}</td><td>${s.batch||'A'}</td><td>${s.year||'1st'}</td></tr>`;
            });
            html += '</table></div>';
            document.getElementById('mainContent').innerHTML = html;
        }
        function showFacultyList() {
            let html = '<div style="background:white; padding:20px;"><h2>Faculty List</h2><table style="width:100%; border-collapse:collapse;"><tr><th>#</th><th>Name</th><th>Department</th><th>Designation</th><th>Email</th></tr>';
            staffList.forEach((s,i) => {
                html += `<tr><td>${i+1}</td><td>${s.name}</td><td>${s.department||''}</td><td>${s.designation||''}</td><td>${s.email}</td></tr>`;
            });
            html += '</table></div>';
            document.getElementById('mainContent').innerHTML = html;
        }
        function showPlaceholder(p) { document.getElementById('mainContent').innerHTML = `<div style="background:white; padding:20px;"><h2>${p}</h2><p>Coming soon!</p></div>`; }

        // ==================== UTILITIES ====================
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        function searchMenu(q) {
            document.querySelectorAll('.menu-grid-item').forEach(i => {
                i.style.display = i.innerText.toLowerCase().includes(q.toLowerCase()) ? 'flex' : 'none';
            });
        }
        function clearRecent() { recentItems = []; updateRecentItems(); }
        function updateRecentItems() {
            const div = document.getElementById('recentItems');
            if (recentItems.length === 0) div.innerHTML = '<div class="recent-item">No recent</div>';
            else div.innerHTML = recentItems.map(i => `<div class="recent-item" onclick="navigateTo('${i.toLowerCase().replace(/ /g,'')}')"><span>${getIconForItem(i)}</span><span>${i}</span></div>`).join('');
        }
        function getIconForItem(i) {
            const icons = {'Library Go':'üìö','Attendance':'‚úÖ','Fees':'üí∞','My Account':'üë§','Feedback':'üí¨','Departments':'üèõÔ∏è','All Courses':'üìö','Students List':'üë•','Faculty List':'üë®‚Äçüè´'};
            return icons[i]||'üìå';
        }

        async function testConnection() {
            showLoading();
            try {
                await db.collection('students').limit(1).get();
                showNotification(`‚úÖ Firebase connected. Students: ${studentsList.length}`, 'success');
            } catch(e) {
                showNotification('‚ùå Firebase error: '+e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function refreshData() {
            showLoading();
            await loadStudents();
            await loadAttendance();
            if (currentRole === 'staff') await loadFeedbackForStaff();
            else if (currentRole === 'student') await loadLibraryVisitsForStudent();
            hideLoading();
            showNotification('Data refreshed', 'success');
            if (currentPage === 'home') {
                if (currentRole === 'student') showStudentHome();
                else if (currentRole === 'staff') showStaffDashboard();
                else showAdminDashboard();
            } else {
                navigateTo(currentPage);
            }
        }

        function startAutoRefresh() {
            setInterval(() => {
                if (currentUser && currentRole === 'student') {
                    loadAttendance().then(() => {
                        if (currentPage === 'home') showStudentHome();
                        else if (currentPage === 'attendance') showAttendance();
                    });
                } else if (currentUser && currentRole === 'staff') {
                    loadFeedbackForStaff();
                }
            }, 15000);
        }

        function logout() {
            clearSession();
            currentUser = null;
            selectedCourse = null;
            selectedPeriod = 1;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            showNotification('Logged out', 'info');
        }

        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            document.getElementById('notificationIcon').textContent = type === 'success' ? '‚úÖ' : '‚ùå';
            document.getElementById('notificationMessage').textContent = msg;
            n.className = `notification ${type} show`;
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // ==================== EXPORT / IMPORT STUBS ====================
        window.exportAttendance = function() { showNotification('Export function not yet implemented', 'info'); };
        window.importAttendance = function() { showNotification('Import function not yet implemented', 'info'); };
        window.exportStudents = function() { showNotification('Export function not yet implemented', 'info'); };

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            setRole('student');
            loadSession();
            startAutoRefresh();
            updateRecentItems();
        });
    </script>
</body>
</html>